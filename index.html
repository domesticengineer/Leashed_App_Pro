<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pet Advocate Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <style>
    /* Custom CSS to approximate Apple Calendar look */
    .fc {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .fc .fc-toolbar {
      background-color: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      padding: 10px;
    }
    .fc .fc-daygrid-day {
      border: 1px solid #e0e0e0;
    }
    .fc .fc-event {
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 12px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
  <!-- Modal, Toast, Login, Admin sections remain unchanged -->
  <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <p id="modal-message" class="mb-4"></p>
      <button id="modal-confirm" class="bg-blue-500 text-white px-4 py-2 rounded-md mr-2">Confirm</button>
      <button id="modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md">Cancel</button>
    </div>
  </div>
  <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-md hidden">
    <span id="toast-message"></span>
  </div>
  <div id="login" class="container mx-auto p-4">
    <div class="bg-white rounded-lg shadow-md p-6 max-w-md mx-auto">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Pet Advocate Portal Login</h1>
      <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
      <div class="mb-4">
        <label for="username" class="block text-gray-700">Username</label>
        <input id="username" type="text" placeholder="Enter username" class="w-full p-2 border border-gray-300 rounded-md" required>
      </div>
      <div class="mb-4">
        <label for="password" class="block text-gray-700">Password</label>
        <input id="password" type="password" placeholder="Enter password" class="w-full p-2 border border-gray-300 rounded-md" required>
      </div>
      <button class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="handleLogin()">Login</button>
    </div>
  </div>
  <div id="admin" class="container mx-auto p-4 hidden">
    <!-- Admin dashboard content remains unchanged -->
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
      <button class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" onclick="handleLogout()">Logout</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Create New Pet Advocate</h2>
        <div id="advocate-error" class="text-red-500 text-sm mb-4 hidden"></div>
        <div class="mb-4">
          <label for="new-firstname" class="block text-gray-700">First Name</label>
          <input id="new-firstname" type="text" placeholder="First Name" class="w-full p-2 border border-gray-300 rounded-md" required>
        </div>
        <!-- Other fields remain unchanged -->
        <button class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="createPetAdvocate()">Create Pet Advocate</button>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Master Calendar</h2>
        <div id="admin-calendar" class="mb-4"></div>
        <div id="calendar-warning" class="text-red-500 text-sm mb-4 hidden">No events available</div>
        <div class="mt-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Add Client Request</h3>
          <div id="client-error" class="text-red-500 text-sm mb-4 hidden"></div>
          <div class="space-y-4">
            <div>
              <label for="client-title" class="block text-gray-700">Event Title</label>
              <input id="client-title" type="text" placeholder="e.g., Walk with Max" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
              <label for="client-date" class="block text-gray-700">Date</label>
              <input id="client-date" type="date" min="2025-07-26" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
              <label for="client-time" class="block text-gray-700">Time</label>
              <input id="client-time" type="time" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <button class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600" onclick="addClientRequest()">Add Client Request</button>
            <button class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 ml-2" onclick="addRequestedEvent()">Add Sample Requested Event</button>
          </div>
        </div>
        <!-- Export/Import remains unchanged -->
      </div>
    </div>
    <!-- Pet Advocates and Service Reports sections remain unchanged -->
  </div>
  <div id="pet-advocate" class="container mx-auto p-4 hidden">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800">Pet Advocate Dashboard</h1>
      <button class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" onclick="handleLogout()">Logout</button>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 mb-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Onboarding Checklist</h2>
      <ul id="onboarding-list" class="space-y-2"></ul>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 mb-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Schedule</h2>
      <p class="text-gray-600 mb-4">1. View client requests (orange) and click to accept. 2. Submit service reports for booked (green) events. 3. Set your availability below.</p>
      <div id="advocate-calendar" class="mb-4"></div>
      <div id="advocate-calendar-warning" class="text-red-500 text-sm mb-4 hidden">No events available</div>
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Set Availability</h3>
      <div id="availability-error" class="text-red-500 text-sm mb-4 hidden"></div>
      <div class="space-y-4">
        <div>
          <label for="advocate-date" class="block text-gray-700">Date</label>
          <input id="advocate-date" type="date" min="2025-07-26" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        <div>
          <label for="advocate-time" class="block text-gray-700">Time</label>
          <input id="advocate-time" type="time" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        <button class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="setAvailability()">Set Availability</button>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 mb-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Service Report</h2>
      <div id="report-error" class="text-red-500 text-sm mb-4 hidden"></div>
      <div class="mb-4">
        <label for="report-schedule" class="block text-gray-700">Schedule</label>
        <select id="report-schedule" class="w-full p-2 border border-gray-300 rounded-md" required>
          <option value="">Select Schedule</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="report-pet-name" class="block text-gray-700">Pet Name</label>
        <input id="report-pet-name" type="text" placeholder="Enter pet name" class="w-full p-2 border border-gray-300 rounded-md" required>
      </div>
      <div class="mb-4">
        <label for="report-start-time" class="block text-gray-700">Start Time</label>
        <input id="report-start-time" type="datetime-local" class="w-full p-2 border border-gray-300 rounded-md" required>
      </div>
      <div class="mb-4">
        <label for="report-end-time" class="block text-gray-700">End Time</label>
        <input id="report-end-time" type="datetime-local" class="w-full p-2 border border-gray-300 rounded-md" required>
      </div>
      <div class="mb-4">
        <label for="report-pee" class="block text-gray-700">Pee</label>
        <select id="report-pee" class="w-full p-2 border border-gray-300 rounded-md" required>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="report-poop" class="block text-gray-700">Poop</label>
        <select id="report-poop" class="w-full p-2 border border-gray-300 rounded-md" required>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="service-type" class="block text-gray-700">Service Type</label>
        <select id="service-type" class="w-full p-2 border border-gray-300 rounded-md" required>
          <option value="20 Minute Walk">20 Minute Walk</option>
          <option value="30 Minute Walk">30 Minute Walk</option>
          <option value="60 Minute Walk">60 Minute Walk</option>
          <option value="Pup Date">Pup Date</option>
          <option value="Sitting">Sitting</option>
          <option value="Boarding">Boarding</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="service-notes" class="block text-gray-700">Notes</label>
        <textarea id="service-notes" placeholder="Enter service notes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
      </div>
      <button class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" onclick="submitServiceReport()">Submit Report</button>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 mt-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Reports</h2>
      <ul id="advocate-reports" class="space-y-2"></ul>
    </div>
  </div>
  <script>
    // Initialize data
    function initializeData() {
      const defaultData = {
        users: [
          { id: 'admin1', firstName: 'Admin', lastName: 'User', address: '123 Main St', city: 'Anytown', state: 'CA', zip: '12345', username: 'admin', password: btoa('admin123'), role: 'admin' },
          { id: 'advocate1', firstName: 'John', lastName: 'Doe', address: '456 Elm St', city: 'Othertown', state: 'NY', zip: '67890', username: 'advocate1', password: btoa('advocate123'), role: 'pet-advocate', onboarding: { proposal: false, backgroundCheck: false, '1099': false, everify: false, photo: false } },
        ],
        schedules: [],
        reports: [],
      };
      if (!localStorage.getItem('advocateData')) {
        localStorage.setItem('advocateData', JSON.stringify(defaultData));
      }
      if (!localStorage.getItem('calendarEvents')) {
        localStorage.setItem('calendarEvents', JSON.stringify([]));
      }
    }

    // Data access
    function getData() {
      return JSON.parse(localStorage.getItem('advocateData') || '{}');
    }

    function saveData(data) {
      localStorage.setItem('advocateData', JSON.stringify(data));
    }

    const CALENDAR_DATA_URL = '/calendar-data.json';
    let calendarData = { events: [] };
    let currentUser = null;
    let adminCalendar = null;
    let advocateCalendar = null;

    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-message').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showModal(message, onConfirm) {
      const modal = document.getElementById('modal');
      document.getElementById('modal-message').textContent = message;
      document.getElementById('modal-confirm').onclick = () => {
        onConfirm();
        modal.classList.add('hidden');
      };
      document.getElementById('modal-cancel').onclick = () => modal.classList.add('hidden');
      modal.classList.remove('hidden');
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const year = date.getFullYear().toString().slice(-2);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${month}-${day}-${year} ${hours}:${minutes}`;
    }

    function calculateDuration(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);
      const diffMs = endDate - startDate;
      const diffMins = Math.round(diffMs / 60000);
      return `${diffMins} minutes`;
    }

    function loadCalendarData() {
      console.log('Loading calendar data...');
      fetch(CALENDAR_DATA_URL)
        .then(response => response.json())
        .then(data => {
          console.log('Fetched events from JSON:', data.events);
          const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
          console.log('Local events:', localEvents);
          const allEvents = [...data.events, ...localEvents];
          const uniqueEvents = Array.from(new Map(allEvents.map(event => [event.id, event])).values())
            .filter(event => event.id && event.title && event.start && event.end);
          calendarData.events = uniqueEvents;
          console.log('Merged and validated events:', calendarData.events);
          renderCalendars();
        })
        .catch(error => {
          console.warn('Failed to fetch JSON, using local events:', error);
          const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]')
            .filter(event => event.id && event.title && event.start && event.end);
          calendarData.events = localEvents;
          console.log('Loaded local events:', calendarData.events);
          renderCalendars();
        });
    }

    function saveLocalEvent(event) {
      const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
      const existingIndex = localEvents.findIndex(e => e.id === event.id);
      event.color = event.status === 'available' && event.clientId && !event.advocateId ? '#f97316' :
                    event.status === 'booked' ? '#22c55e' :
                    event.status === 'completed' ? '#6b7280' :
                    event.advocateId ? '#3b82f6' : '#ef4444';
      if (!event.id || !event.title || !event.start || !event.end) {
        console.warn('Invalid event data:', event);
        return;
      }
      if (existingIndex !== -1) {
        localEvents[existingIndex] = event;
      } else {
        localEvents.push(event);
      }
      localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
      console.log(`Saved event: ${event.status} ${event.id} for ${event.start}`);
      loadCalendarData();
    }

    function addRequestedEvent() {
      const event = {
        id: `event${Date.now()}`,
        title: 'Requested: Sample Pet',
        start: '2025-08-01T10:00:00',
        end: '2025-08-01T11:00:00',
        advocateId: null,
        clientId: `client${Date.now()}`,
        status: 'available',
        public: true,
      };
      saveLocalEvent(event);
      showToast('Added "Requested" event for 2025-08-01 10:00 AM');
    }

    function addClientRequest() {
      const title = document.getElementById('client-title').value;
      const date = document.getElementById('client-date').value;
      const time = document.getElementById('client-time').value;
      const errorDiv = document.getElementById('client-error');
      if (!title || !date || !time) {
        errorDiv.textContent = 'Please provide title, date, and time';
        errorDiv.classList.remove('hidden');
        return;
      }
      errorDiv.classList.add('hidden');
      const start = `${date}T${time}:00`;
      const end = new Date(start);
      end.setHours(end.getHours() + 1);
      const event = {
        id: `event${Date.now()}`,
        title: `Client Request: ${title}`,
        start,
        end: end.toISOString(),
        advocateId: null,
        clientId: `client${Date.now()}`,
        status: 'available',
        public: true,
      };
      saveLocalEvent(event);
      showToast(`Client request "${title}" added`);
      document.getElementById('client-title').value = '';
      document.getElementById('client-date').value = '';
      document.getElementById('client-time').value = '';
    }

    function showSection(sectionId) {
      ['login', 'admin', 'pet-advocate'].forEach(id => {
        document.getElementById(id).classList.toggle('hidden', id !== sectionId);
      });
    }

    function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      const data = getData();
      if (!username || !password) {
        errorDiv.textContent = 'Please provide username and password';
        errorDiv.classList.remove('hidden');
        return;
      }
      const user = data.users.find(
        u => u.username.toLowerCase() === username.toLowerCase() && u.password === btoa(password)
      );
      if (user) {
        currentUser = user;
        errorDiv.classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        if (user.role === 'admin') {
          showSection('admin');
          loadCalendarData();
          renderAdmin();
        } else {
          showSection('pet-advocate');
          loadCalendarData();
          renderPetAdvocate();
        }
      } else {
        errorDiv.textContent = 'Invalid username or password';
        errorDiv.classList.remove('hidden');
      }
    }

    function handleLogout() {
      currentUser = null;
      showSection('login');
      if (adminCalendar) adminCalendar.destroy();
      if (advocateCalendar) advocateCalendar.destroy();
      adminCalendar = null;
      advocateCalendar = null;
    }

    function createPetAdvocate() {
      const firstName = document.getElementById('new-firstname').value;
      const lastName = document.getElementById('new-lastname').value;
      const address = document.getElementById('new-address').value;
      const city = document.getElementById('new-city').value;
      const state = document.getElementById('new-state').value;
      const zip = document.getElementById('new-zip').value;
      const username = document.getElementById('new-username').value;
      const password = document.getElementById('new-password').value;
      const errorDiv = document.getElementById('advocate-error');
      const data = getData();
      if (!firstName || !lastName || !address || !city || !state || !zip || !username || !password) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.classList.remove('hidden');
        return;
      }
      if (data.users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
        errorDiv.textContent = 'Username already exists';
        errorDiv.classList.remove('hidden');
        return;
      }
      errorDiv.classList.add('hidden');
      data.users.push({
        id: `advocate${data.users.length + 1}`,
        firstName,
        lastName,
        address,
        city,
        state,
        zip,
        username,
        password: btoa(password),
        role: 'pet-advocate',
        onboarding: { proposal: false, backgroundCheck: false, '1099': false, everify: false, photo: false }
      });
      saveData(data);
      document.getElementById('new-firstname').value = '';
      document.getElementById('new-lastname').value = '';
      document.getElementById('new-address').value = '';
      document.getElementById('new-city').value = '';
      document.getElementById('new-state').value = '';
      document.getElementById('new-zip').value = '';
      document.getElementById('new-username').value = '';
      document.getElementById('new-password').value = '';
      showToast('Pet Advocate created successfully');
      renderAdmin();
    }

    function updateOnboarding(userId, task) {
      const data = getData();
      const user = data.users.find(u => u.id === userId);
      if (user && user.onboarding) {
        user.onboarding[task] = !user.onboarding[task];
        saveData(data);
        renderAdmin();
        console.log(`Onboarding task '${task}' for user ${userId} set to ${user.onboarding[task]}`);
      }
    }

    function updatePassword(userId) {
      const newPassword = prompt(`Enter new password for user ${userId}:`);
      if (newPassword) {
        const data = getData();
        const user = data.users.find(u => u.id === userId);
        if (user) {
          user.password = btoa(newPassword);
          saveData(data);
          showToast('Password updated
